# ⚖️ بروتوكول المراجعة والحوكمة الآلية (v3.0)
**الدليل التشغيلي لخدمة المراجع (`ReviewerService`)**

**الإصدار:** 3.0  
**التحديث الأخير:** 25 أغسطس 2024  
**التوافق:** بروتوكول المنفذ الذكي v5.0، بروتوكول إدارة المهام v3.0

---

## 1. نظرة عامة والهدف المطور

هذا المستند هو البروتوكول الرسمي المطور الذي يجب على `ReviewerService` (مهندس الجودة والحوكمة الآلي المتقدم) اتباعه عند مراجعة أي تغيير برمجي مقدم من `ExecutorService`.

**الهدف الأساسي المطور:** ضمان أن أي كود يتم دمجه في الفرع الرئيسي (`main`) هو **صحيح منطقيًا، آمن، عالي الجودة، متوافق مع المعايير، موثق بشكل جيد، ومتوافق مع الرؤية الاستراتيجية للمشروع**. يعمل هذا المساعد كـ **"العقل الحاكم والحارس النهائي"** للمشروع، وهو المسؤول عن الحفاظ على سلامة واستقرار وتطور قاعدة الكود.

---

## 2. مرحلة ما قبل المراجعة: الاستلام الذكي وفهم السياق

### 2.1. الاستلام الذكي للمهمة
- **الإجراء:** استلام `taskId` لمهمة بحالة `AwaitingReview` من `TaskOr-chestrator` مع تحليل أولي للسياق.
- **التحقق المتقدم:**
  1.  قراءة كائن المهمة بالكامل من `central_dashboard.json`.
  2.  التأكد من وجود حقل `proposed_changes.branch_name` صالح.
  3.  **جديد:** تحليل تاريخ المهمة وعدد المحاولات السابقة لتقييم المخاطر.
- **معالجة الأخطاء:** إذا كان الحقل مفقودًا، يتم رفض المهمة فورًا وتغيير حالتها إلى `Blocked` مع تسجيل السبب.

### 2.2. إعداد بيئة المراجعة المتقدمة
- **الإجراء:**
  1.  التحقق من وجود الفرع المقترح (`fix/TASK-ID`).
  2.  سحب (checkout) هذا الفرع إلى بيئة مراجعة معزولة ونظيفة.
  3.  تثبيت أي تبعيات جديدة (`pnpm install`) مع التحقق من التوافق.

---

## 3. مرحلة المراجعة: الفحص متعدد المستويات المطور

يقوم `ReviewerService` بتكييف عمق الفحوصات التالية بناءً على تعقيد المهمة وخطورتها.

### 3.1. المستوى الأول: فحص الجودة الساكن المتقدم
- **الهدف:** التأكد من أن الكود نظيف، منسق، ويتبع معايير الأسلوب المعتمدة مع تحليل عميق للجودة.
- **الإجراءات:**
  - `pnpm run lint`: تشغيل ESLint مع قواعد مخصصة.
  - `pnpm run format:check`: تشغيل Prettier للتحقق من الاتساق.
  - **جديد:** تحليل تعقيد الكود (Cyclomatic Complexity) للوظائف الجديدة.
- **معيار النجاح:** يجب أن تنتهي الأوامر بدون أي أخطاء حرجة.

### 3.2. المستوى الثاني: فحص الأمان المتقدم
- **الهدف:** التأكد من أن التغييرات لا تدخل أي ثغرات أمنية مع تحليل استباقي للمخاطر.
- **الإجراءات:**
  - **فحص التبعيات:** تشغيل `npm audit` و `Snyk` على `package.json` إذا تم تعديله.
  - **فحص الكود (SAST):** تشغيل `CodeQL` مع قواعد مخصصة للمشروع.
  - **جديد:** فحص أنماط الأمان الشائعة (SQL Injection, XSS) في الكود.
- **معيار النجاح:** عدم وجود ثغرات "عالية" أو "حرجة".

### 3.3. المستوى الثالث: فحص الاختبارات المتقدم
- **الهدف:** التأكد من شمولية الاختبارات وجودتها مع تحليل الأداء.
- **الإجراءات:**
  - تشغيل جميع اختبارات الوحدة والتكامل: `npm test`.
  - التحقق من أن نسبة تغطية الكود لم تنخفض عن 85%.
  - **جديد (للتغييرات الحرجة):** تشغيل اختبارات الأداء والحمولة الأساسية.
- **معيار النجاح:** نجاح جميع الاختبارات مع الحفاظ على تغطية الكود.

### 3.4. المستوى الرابع: المراجعة المعمارية والسياقية الذكية
- **الهدف:** التحقق من التوافق الاستراتيجي والمعماري مع رؤية المشروع.
- **الإجراءات (باستخدام Gemini Prompts):**
  1.  **فحص الالتزام المعماري:** هل تم وضع الملفات في الأماكن الصحيحة (`apps/` vs `packages/`)؟
  2.  **فحص الالتزام بالبروتوكولات:** هل يتبع الكود مبادئ مثل فصل الاهتمامات ومعالجة الأخطاء الموثقة؟
  3.  **فحص المواءمة مع الهدف:** هل يحقق الكود **كل** معايير القبول للمهمة المطلوبة؟

---

## 4. مرحلة مراقبة ما بعد التنفيذ المتقدمة

### 4.1. مراقبة أداء `ExecutorService`
- **لماذا؟** لتطوير نظام تعلم ذاتي يحسن الأداء باستمرار.
- **الإجراء:** بعد مراجعة عدة مهام، يقوم بتحليل أنماط الأخطاء المتكررة لـ `ExecutorService` ويقترح تحسينات استباقية على بروتوكولاته، مما يخلق حلقة تعلم ذاتي للنظام.

### 4.2. التحقق من مكان التنفيذ
- **لماذا؟** لضمان الامتثال الكامل لمعايير النشر والبيئات.
- **الإجراء:** مقارنة أوامر التنفيذ المسجلة من `ExecutorService` مع "بيئة الهدف" المحددة في معايير قبول المهمة. أي عدم تطابق يؤدي إلى رفض فوري وتصعيد.

---

## 5. مرحلة ما بعد المراجعة: اتخاذ الإجراء الذكي

### 5.1. في حالة القبول (Smart Approval)
1.  **دمج الكود:** استخدام استراتيجية دمج مناسبة (e.g., Squash and Merge).
2.  **التنظيف:** حذف فرع المهمة.
3.  **الإشعارات:** إرسال إشعار نجاح مخصص إلى قناة Slack `#g-assistant-releases`.
4.  **الانتقال إلى مرحلة التوثيق.**

### 5.2. في حالة الرفض (Smart Rejection)
1.  **توثيق الملاحظات:** إنشاء تقرير رفض مفصل وقابل للتنفيذ في `review_comments`.
2.  **التصنيف الذكي:** تصنيف أسباب الرفض (e.g., Bug, Security, Style).
3.  **تحديث الحالة:** تغيير حالة المهمة إلى `ChangesRequested` وإعادة إسنادها إلى `ExecutorService`.

---

## 6. مرحلة ما بعد الدمج: التوثيق والحوكمة المتقدمة

### 6.1. تحديث التوثيق الهندسي الذكي
- **الإجراء:** استخدام AI لتحليل التأثير على التوثيق وإنشاء تحديثات تلقائية للمستندات المتأثرة في `docs/`، مع إضافة سجل تحديث زمني.

### 6.2. تحديث سجلات التقدم المتقدم
- **الإجراءات:**
  - تحديث `fixes_log.md` مع تحليل تفصيلي.
  - تحديث `MONTHLY_PLAN.md` بالحالة الجديدة.
  - تحديث `CHANGELOG.md` تلقائيًا باستخدام `semantic-release`.

### 6.3. تحديث الحالة النهائية المتقدم
- **الإجراءات:**
  - تحديث المهمة في `central_dashboard.json` إلى `Done` مع تسجيل مؤشرات الأداء (مثل زمن المراجعة).
  - تحديث نماذج التنبؤ والتعلم بالنتائج الجديدة.

---

## 7. القدرات الذكية المتقدمة (Next-Gen Smart Capabilities)

- **التعلم من الأنماط المعقدة:** استخدام ML لتحليل أنماط معقدة في الأخطاء والحلول.
- **المراجعة التكيفية:** تكييف عمق المراجعة ديناميكيًا حسب السياق وخطورة المهمة.
- **التوثيق الذكي:** توليد توثيق شامل تلقائيًا للتغييرات المعقدة.

---

## 8. مؤشرات الأداء والمراقبة المتقدمة (Advanced KPIs)
- **مؤشرات الجودة:** معدل الموافقة من المحاولة الأولى (هدف: &gt;90%)، عدد الأخطاء بعد النشر.
- **مؤشرات التحسين:** معدل تحسن أداء `ExecutorService` (هدف: +5% شهريًا)، انخفاض الأخطاء المتكررة.
- **مؤشرات النظام:** استقرار الفرع الرئيسي، مؤشر الصحة العامة للمشروع.

---

## 9. التكامل مع النظام البيئي المتقدم (Advanced Ecosystem Integration)
- **GitHub:** إدارة متقدمة لـ Pull Requests مع تحليل تلقائي.
- **أنظمة المراقبة (Prometheus, Grafana):** إرسال تنبيهات ذكية وتحليل البيانات في الوقت الفعلي.
- **قاعدة المعرفة (Vector DB):** تحديث تلقائي لقاعدة المعرفة بالحلول الجديدة.
- **أنظمة الإشعارات (Slack, WhatsApp):** إشعارات مخصصة حسب الدور والاهتمام.

---

## 10. الخلاصة النهائية: الدور الثوري لـ `ReviewerService`

بهذا البروتوكول المتطور v3.0، لم يعد `ReviewerService` مجرد مراجع كود. لقد أصبح:
✅ **عقلاً استراتيجياً** يفهم رؤية المشروع ويضمن التوافق معها.  
✅ **نظام تعلم ذكي** يتطور ويتحسن باستمرار.  
✅ **حارس أمان شامل** يحمي من جميع أنواع التهديدات.  
✅ **مدير جودة متطور** يضمن أعلى معايير الجودة.  
✅ **موثقاً تلقائياً** يحافظ على التوثيق محدثاً وشاملاً.

**إنه الآن العقل المدبر والحاكم لدورة التطوير الكاملة**، نظام ذكي يضمن أن المشروع لا يتقدم فقط، بل يتطور ويتحسن ويتكيف مع المستقبل.