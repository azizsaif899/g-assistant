# تقرير الخطة الشاملة لعمل تطبيق CRM في مشروع AzizSys AI Assistant v2.0

يقدم هذا التقرير ملخصًا للخطة الشاملة لعمل نظام إدارة علاقات العملاء (CRM) في مشروع AzizSys AI Assistant v2.0، استنادًا إلى المعلومات المستمدة من وثائق المشروع المتوفرة في المسار `g-assistant-nx/docs/crm/`.

## نظرة عامة على بنية CRM

يتبع نظام CRM في مشروع AzizSys AI Assistant v2.0 بنية معمارية متعددة الطبقات لضمان الفصل بين الاهتمامات وقابلية التوسع. تتكون البنية الرئيسية من الطبقات التالية:

*   **طبقة قاعدة البيانات (Database Layer):** المسؤولة عن تخزين بيانات العملاء المحتملين، مراحل المبيعات، مصادر العملاء، الرسائل، والأنشطة.
*   **طبقة التكامل (Integration Layer):** المسؤولة عن الربط والتواصل مع الأنظمة الخارجية مثل Odoo CRM و WhatsApp Business API.
*   **طبقة منطق الأعمال (Business Logic Layer):** تحتوي على المنطق الأساسي لإدارة دورة حياة العميل المحتمل، حساب الإحصائيات، وإدارة الأنشطة والمهام.
*   **طبقة العرض (Presentation Layer):** توفر الواجهات الأمامية للمستخدمين للتفاعل مع نظام CRM، مثل لوحة التحكم.
*   **طبقة التحليلات (Analytics Layer):** مسؤولة عن تتبع الأحداث، جمع البيانات، تحليل الأداء، وإنشاء التقارير.
*   **طبقة التواصل (Communication Layer):** تتعامل مع إرسال واستقبال الرسائل والإشعارات، وخاصة عبر WhatsApp.

## طبقات ومكونات CRM الرئيسية

| الطبقة (Layer)       | المكون (Component)         | الوظيفة والأهمية                                                                 |
| :------------------- | :------------------------- | :------------------------------------------------------------------------------- |
| Database Layer       | PostgreSQL Database        | قاعدة البيانات الرئيسية لتخزين جميع بيانات CRM.                                 |
|                      | جداول Odoo (`crm.lead`, etc.) | تخزين تفاصيل العملاء المحتملين، المراحل، المصادر، الرسائل، والأنشطة.              |
| Integration Layer    | Odoo Connector             | يمثل الموصل الأساسي للتواصل مع Odoo API وتنفيذ عمليات CRUD.                       |
|                      | WhatsApp CRM Bridge        | يعمل كجسر للتكامل بين WhatsApp و CRM، معالجة رسائل WhatsApp وإنشاء عملاء محتملين. |
|                      | CRM Webhook Handler        | يستقبل ويعالج Webhook من WhatsApp ويوجه الرسائل للمعالجة.                          |
| Business Logic Layer | CRM Service                | يمثل خدمة CRM الرئيسية التي تحتوي على منطق إدارة العملاء ودورة حياتهم.          |
|                      | Lead Management            | مسؤول عن إدارة دورة حياة العميل المحتمل، تطبيق قواعد الأعمال، والمتابعة التلقائية. |
|                      | Activity Manager           | يدير مهام وأنشطة فريق المبيعات وجدولتها وتتبع إنجازها.                            |
| Presentation Layer   | CRM Dashboard Component    | الواجهة الرئيسية لعرض إحصائيات CRM وإدارة العملاء المحتملين.                     |
|                      | Leads Management Component | مكون متخصص لعرض وإدارة قائمة العملاء المحتملين وتفاصيلهم.                        |
|                      | Analytics Dashboard        | لوحة لعرض التحليلات والتقارير المتعلقة بأداء CRM.                               |
| Analytics Layer      | GTM Engine                 | يستخدم لتتبع أحداث CRM وإرسالها إلى Google Analytics لقياس الأداء.             |
|                      | Analytics Service          | يجمع ويحلل بيانات الأداء ويقوم بإنشاء التقارير وحساب المقاييس.                     |
| Communication Layer  | WhatsApp Service           | يدير إرسال واستقبال رسائل WhatsApp ويتعامل مع القوالب والوسائط.                   |
|                      | Notification Service       | مسؤول عن إرسال الإشعارات والتنبيهات لفريق المبيعات عبر قنوات مختلفة.               |

## تكامل CRM مع الأنظمة الخارجية (Odoo و WhatsApp)

يتم تحقيق التكامل مع الأنظمة الخارجية كالتالي:

*   **تكامل Odoo:** يتم بشكل أساسي عبر `Odoo Connector` الذي يستخدم Odoo XML-RPC API للتواصل مع قاعدة بيانات Odoo. يسمح هذا المكون بإجراء عمليات إنشاء، قراءة، تحديث، وحذف (CRUD) على سجلات CRM في Odoo، بالإضافة إلى البحث والاستعلام.
*   **تكامل WhatsApp:** يتم عبر `WhatsApp CRM Bridge` و `CRM Webhook Handler`. يستقبل `Webhook Handler` الرسائل الواردة من WhatsApp، ويقوم `CRM Bridge` بمعالجتها. تتضمن المعالجة البحث عن عميل محتمل موجود أو إنشاء عميل جديد في Odoo بناءً على الرسالة، إضافة الرسالة كسجل لنشاط العميل، وجدولة مهام متابعة تلقائية. يتم أيضاً إرسال ردود تلقائية عبر WhatsApp باستخدام `WhatsApp Service`.

## دورة حياة العميل المحتمل في CRM

تبدأ دورة حياة العميل المحتمل عادةً برسالة WhatsApp جديدة. عند استقبال رسالة، يقوم النظام بالخطوات التالية:

1.  **البحث عن عميل موجود:** يتحقق النظام مما إذا كان رقم الهاتف المرسل مرتبطًا بعميل محتمل موجود في Odoo.
2.  **إنشاء أو تحديث العميل:** إذا لم يتم العثور على عميل، يتم إنشاء سجل عميل محتمل جديد في Odoo بتفاصيل مستمدة من رسالة WhatsApp. إذا تم العثور على عميل، يمكن تحديث سجله بمعلومات جديدة.
3.  **إضافة الرسالة كسجل:** يتم تسجيل محتوى رسالة WhatsApp كنشاط أو تعليق مرتبط بسجل العميل المحتمل في Odoo.
4.  **جدولة مهمة متابعة:** يتم إنشاء مهمة متابعة تلقائية لفريق المبيعات (مثل مكالمة هاتفية) بتاريخ استحقاق محدد.
5.  **إرسال رد تلقائي:** يتم إرسال رد تلقائي إلى العميل عبر WhatsApp لإعلامه باستلام رسالته والخطوات التالية.
6.  **تتبع GTM:** يتم تسجيل الحدث في Google Tag Manager لتتبع مسار العميل وأداء المصادر.
7.  **إشعار فريق المبيعات:** يتم إرسال إشعار إلى مندوب المبيعات المسؤول أو الفريق المعني بوجود عميل محتمل جديد أو تحديث على عميل موجود.

يمر العميل المحتمل بعد ذلك بمراحل مختلفة في دورة المبيعات (مثل مؤهل، عرض سعر، فاز، فقد) والتي يتم إدارتها وتحديثها في Odoo عبر واجهة المستخدم أو منطق الأعمال.

## التحليلات والتقارير في CRM

يستخدم نظام CRM كلاً من Google Tag Manager (GTM) وخدمة التحليلات (`Analytics Service`) لجمع وتحليل البيانات وإنشاء التقارير.

*   **GTM Engine:** يقوم بتتبع أحداث محددة في CRM (مثل استلام رسالة WhatsApp، إنشاء عميل محتمل، تغيير مرحلة العميل) وإرسال هذه البيانات إلى Google Analytics أو منصات تحليلية أخرى لقياس الأداء وتتبع سلوك المستخدم.
*   **Analytics Service:** يقوم بجمع البيانات من مصادر مختلفة (بما في ذلك Odoo) ويستخدمها لحساب المقاييس الرئيسية لـ CRM مثل معدلات التحويل، أداء مصادر العملاء، وأداء فريق المبيعات. يمكنه أيضًا إنشاء تقارير مفصلة ولوحات تحكم لمراقبة الأداء العام لنظام CRM.

## أدوات وتقنيات التطوير الموصى بها

للتطوير على مكونات CRM في هذا المشروع، يوصى باستخدام الأدوات والتقنيات التالية:

*   **Node.js** (الإصدار 18 أو أحدث)
*   **TypeScript** (الإصدار 5 أو أحدث)
*   **Docker Desktop:** لتشغيل Odoo وقاعدة البيانات محلياً.
*   **Postman:** لاختبار API endpoints.
*   **VS Code:** كمحرر أكواد مع Extensions مناسبة لـ Node.js و TypeScript و React.
*   **Git:** للتحكم في الإصدارات والتعاون.
*   **Chrome DevTools:** لتصحيح أخطاء الواجهة الأمامية.
*   **Jest:** لكتابة وتشغيل اختبارات الوحدة والتكامل.
*   **Winston:** لإدارة السجلات (Logging).
*   **Prometheus:** لمراقبة الأداء (Monitoring).

## نصائح وإرشادات للمطورين

يقدم المشروع نصائح مهمة للمطورين الجدد الذين يعملون على مكونات CRM:

*   **البدء بـ API قبل الواجهة:** التركيز على بناء منطق الأعمال والتكاملات أولاً قبل تطوير الواجهة الأمامية.
*   **اختبار كل شيء:** كتابة وتشغيل الاختبارات بشكل مستمر لضمان عمل المكونات بشكل صحيح.
*   **استخدام TypeScript:** للاستفادة من ميزات الأمان والتصحيح المبكر للأخطاء.
*   **التوثيق أثناء العمل:** توثيق الكود والعمليات لتسهيل الصيانة والتعاون المستقبلي.
*   **مراقبة الأداء:** الانتباه إلى أداء المكونات وتحسينها باستمرار.
*   **التعامل مع البيانات الحقيقية:** استخدام بيانات حقيقية قدر الإمكان في مرحلة التطوير والاختبار.
*   **الاعتماد على الأحداث:** استخدام نظام الأحداث للتكامل بين المكونات المختلفة.

## ملفات ومجلدات المشروع ذات الصلة بالـ CRM

الملفات والمجلدات التالية هي الأكثر صلة بمكونات CRM في المشروع:

*   **`g-assistant-nx/apps/crm/`**: المجلد الجديد المخصص لتطبيق CRM.
*   **`g-assistant-nx/apps/crm/CRM_تقرير_وملفات_ذات_صلة.md`**: ملف التقرير الحالي.
*   **`g-assistant-nx/apps/crm/index.tsx`**: ملف الواجهة الأمامية الأساسي لتطبيق CRM.
*   **`g-assistant-nx/docs/crm/`**: مجلد يحتوي على الوثائق الشاملة المتعلقة بالـ CRM، بما في ذلك:
    *   `CRM_ARCHITECTURE.md`
    *   `CRM_DEVELOPER_GUIDE.md`
    *   `REAL_WORLD_EXAMPLES.md`
    *   `ODOO_API_REFERENCE.md`
    *   `WHATSAPP_CRM_INTEGRATION.md`
    *   ...وغيرها من ملفات الوثائق المذكورة سابقاً.
*   **`g-assistant-nx/packages/odoo-integration/`**: يحتوي على المكونات المسؤولة عن التكامل مع Odoo.
*   **`g-assistant-nx/packages/whatsapp-core/`**: يحتوي على المكونات الأساسية للتعامل مع WhatsApp API.
*   **`g-assistant-nx/packages/analytics-core/`**: يحتوي على المكونات المسؤولة عن التحليلات.
*   **`g-assistant-nx/packages/gtm-engine/`**: يحتوي على المكونات المسؤولة عن تكامل GTM.
*   **`g-assistant-nx/apps/whatsapp-exec-bot/src/crm-webhook.ts`**: معالج Webhook لاستقبال رسائل WhatsApp.
*   **`g-assistant-nx/apps/admin-dashboard/src/components/`**: يحتوي على مكونات لوحة التحكم الحالية، ومن المرجح أن يتم نقل أو إعادة بناء مكونات CRM UI هنا أو في المجلد الجديد `g-assistant-nx/apps/crm/`.
*   **`g-assistant-nx/scripts/quick-start-odoo.bat`**: سكربت لتشغيل بيئة Odoo المحلية.
*   **`g-assistant-nx/scripts/demo-whatsapp-crm.js`**: سكربت لاختبار تكامل WhatsApp CRM.
*   **`g-assistant-nx/tests/integration/crm-integration.test.ts`**: ملف اختبارات التكامل الخاصة بالـ CRM.
*   **`g-assistant-nx/tests/unit/crm-service.test.ts`**: ملف اختبارات الوحدة الخاصة بخدمة CRM.
*   **`docker/odoo-setup.yml`**: ملف إعداد Docker لبيئة Odoo وقاعدة البيانات.
*   **`.env`**: ملف متغيرات البيئة لإعدادات الاتصال بالخدمات الخارجية.
*   **`apps/api/src/routes/crm.routes.ts`**: ملف تعريف مسارات API المتعلقة بالـ CRM (قد يحتاج إلى نقل أو إعادة تنظيم حسب بنية المجلد الجديد).

هذا التقرير يوفر نظرة عامة وموجهة للمطورين للبدء في العمل على تطبيق CRM، مع الإشارة إلى الوثائق ومواقع الملفات الأساسية.
