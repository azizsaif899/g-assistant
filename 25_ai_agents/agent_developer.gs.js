// *************************************************************************************************
// --- START OF FILE: 25_ai_agents/agent_developer.gs ---
// *************************************************************************************************

/**
 * @file 25_ai_agents/agent_developer.gs
 * @module System.AgentDeveloper
 * @version 21 // ุชู ุชุญุฏูุซ ุงูุฅุตุฏุงุฑ ููุนูุณ ุงูุฏูุฌ ุงูุฌุฏูุฏ ูุงูุชูููุฐ ุงููุนูู ูููุธุงุฆู
 * @author ุนุจุฏุงูุนุฒูุฒ
 * @description
 * ูููู ุฐูุงุก ุงุตุทูุงุนู ูุชุฎุตุต ูู ููุงู ุงููุทูุฑูู. ููุชูู ูุฌููุนุฉ ูู ุงููุฏุฑุงุช
 * ููุฑุงุฌุนุฉ ุงูููุฏุ ุงูุชุฑุงุญ ุงูุชุญุณููุงุชุ ูุชุญููู ุฌูุฏุฉ ุงููุดุฑูุน ุจุดูู ุฏูุฑู ูุชูุงุนูู.
 * ูุฏุนู ุงูุขู ูุงุฌูุฉ ููุญุฏุฉ handleRequest ููุชูุฌูู ูู AgentDispatcher.
 * ูุฑุชุจุทุฉ ุจู: AI.Core, Config, Utils, AppsScript API
 */

defineModule('System.AI.Agents.Developer', ({ Utils, Config, DocsManager, AI, Telemetry, Context, Tools, ModuleVerifier, Security }) => {
  const MODULE_VERSION = '2.1.0';
  const METRICS_SHEET = 'AI_Developer_Agent_Metrics';

  DocsManager.registerModuleDocs('System.AI.Agents.Developer', [
    {
      name: 'handleRequest',
      version: MODULE_VERSION,
      description: 'ูุนุงูุฌุฉ ุทูุจุงุช ุงููุทูุฑ ูุน ุชุญููู ููุฏ ูุชูุฏู',
      parameters: {
        type: 'OBJECT',
        properties: {
          sessionId: { type: 'STRING', required: true },
          message: { type: 'STRING', required: true },
          intent: { type: 'OBJECT', required: true }
        }
      }
    },
    {
      name: 'runWeeklyCodeReview',
      version: MODULE_VERSION,
      description: 'ูุฑุงุฌุนุฉ ููุฏ ุฃุณุจูุนูุฉ ุดุงููุฉ ูุน ุชุญููู ุฌูุฏุฉ ูุชูุฏู'
    },
    {
      name: 'analyzeCodeComplexity',
      version: MODULE_VERSION,
      description: 'ุชุญููู ุชุนููุฏ ุงูููุฏ ูุชูุฏูู ุงูุชุฑุงุญุงุช ุงูุชุญุณูู'
    },
    {
      name: 'generateCodeDocumentation',
      version: MODULE_VERSION,
      description: 'ุชูููุฏ ูุซุงุฆู ุงูููุฏ ุชููุงุฆูุงู'
    }
  ]);

  function _recordInvocation(action, status, durationMs, meta = {}) {
    const rec = {
      module: 'AI.Agents.Developer',
      action,
      version: MODULE_VERSION,
      timestamp: new Date().toISOString(),
      status,
      durationMs,
      ...meta
    };

    if (AI?.LongTermMemory?.save) {
      AI.LongTermMemory.save('DeveloperAgentInvocation', rec);
    }

    Telemetry.track('AI.Agents.Developer.Invocation', rec);

    const sheet = Utils.getSheet(METRICS_SHEET, [
      'Timestamp', 'Action', 'Status', 'DurationMs', 'Version', 'Details'
    ]);
    if (sheet) {
      sheet.appendRow([
        new Date(), action, status, durationMs, MODULE_VERSION, 
        JSON.stringify(meta.details || {})
      ]);
    }
  }

  /**
   * ุงููุงุฌูุฉ ุงูููุญุฏุฉ ูุงุณุชูุจุงู ุงูุทูุจุงุช ูู AgentDispatcher.
   * ุชููู ุจุชูุฌูู ุงูุทูุจุงุช ุจูุงุกู ุนูู ุงูููุฉ ุงูููุชุดูุฉ.
   * @param {{ sessionId: string, message: string, intent: object }} args
   * @returns {{ type: string, text: string, data?: any }}
   */
  function handleRequest({ sessionId, message, intent }) {
    const start = Date.now();
    let status = 'processing';

    try {
      // โ ุชุทุจูู ุงูุจุฑูุฌุฉ ุงูุฏูุงุนูุฉ (ุงููุฑุญูุฉ 8ุ ุงูุฎุทูุฉ 4)
      if (!ModuleVerifier?.checkReady('AI', ['Core', 'Context'])) {
        status = 'dependencies_not_ready';
        return { type: 'error', text: 'Developer Agent: Core AI dependencies are not ready.' };
      }
      if (!ModuleVerifier?.checkReady('Tools', ['ProjectService'])) {
        status = 'tools_not_ready';
        return { type: 'error', text: 'Developer Agent: ProjectService tool is not ready.' };
      }

      Utils.log(`Developer Agent: Processing - Intent: ${intent.type}, Message: "${message}"`);

      switch (intent.type) {
        case 'tool_call':
          const toolName = intent.data?.toolName || intent.data?.functionName;
          
          if (toolName === 'Developer.runWeeklyCodeReview') {
            const result = runWeeklyCodeReview();
            status = result.type === 'success' ? 'success' : 'error';
            return result;
          } else if (toolName === 'Developer.generateCodeFromPrompt') {
            const result = generateCodeFromPrompt({ description: intent.data?.description });
            status = result.type === 'success' ? 'success' : 'error';
            return result;
          } else if (toolName === 'Developer.analyzeCodeComplexity') {
            const result = analyzeCodeComplexity(intent.data?.fileName);
            status = result.type === 'success' ? 'success' : 'error';
            return result;
          } else if (toolName === 'Developer.generateCodeDocumentation') {
            const result = generateCodeDocumentation(intent.data?.fileName);
            status = result.type === 'success' ? 'success' : 'error';
            return result;
          } else if (toolName === 'Developer.suggestRefactoring') {
            if (intent.data?.fileName) {
              const result = suggestRefactoring(intent.data.fileName);
              status = result.type === 'success' ? 'success' : 'error';
              return result;
            } else {
              status = 'missing_parameter';
              return { type: 'error', text: 'Developer Agent: ูุชุทูุจ suggestRefactoring ุงุณู ููู.' };
            }
          } else if (toolName === 'Developer.logCodeQualityMetrics') {
            const result = logCodeQualityMetrics();
            status = result.type === 'success' ? 'success' : 'error';
            return result;
          } else {
            status = 'unknown_tool';
            return { 
              type: 'warning', 
              text: `Developer Agent: ุฃุฏุงุฉ ูุทูุฑ ุบูุฑ ูุนุฑููุฉ: ${toolName || 'ุบูุฑ ูุญุฏุฏุฉ'}` 
            };
          }

        case 'general_query':
          if (AI?.Core?.ask) {
            const devPrompt = `ููุทูุฑ ุฎุจูุฑ ูู Google Apps Script ูJavaScriptุ ุฃุฌุจ ุนูู ุงูุณุคุงู ุงูุชุงูู ุจุฏูุฉ ุชูููุฉ:

ุงูุณุคุงู: ${message}

ูุฑุฌู ุชูุฏูู:
1. ุฅุฌุงุจุฉ ุชูููุฉ ููุตูุฉ
2. ุฃูุซูุฉ ููุฏ ุฅุฐุง ูุงูุช ููุงุณุจุฉ
3. ุฃูุถู ุงูููุงุฑุณุงุช
4. ุชุญุฐูุฑุงุช ุชูููุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ
5. ููุงุฑุฏ ุฅุถุงููุฉ ููุชุนูู`;

            const aiResponse = AI.Core.ask(devPrompt, { 
              sessionId,
              generationConfig: { temperature: 0.2, maxOutputTokens: 3000 }
            });
            
            status = aiResponse.type === 'info' ? 'success' : 'ai_error';
            return {
              type: aiResponse.type,
              text: aiResponse.text,
              data: { ...aiResponse.data, agent: 'Developer', expertise: 'technical' }
            };
          } else {
            status = 'ai_unavailable';
            return { 
              type: 'error', 
              text: 'Developer Agent: ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชููุฑุฉ' 
            };
          }

        case 'clarification_needed':
          status = 'clarification';
          return { 
            type: 'warning', 
            text: 'Developer Agent: ูู ููููู ุชูุถูุญ ุทูุจู ุงูุชูููุ ูุซูุงู: ูุฑุงุฌุนุฉ ููุฏุ ุชุญููู ุชุนููุฏุ ุฃู ุชูููุฏ ูุซุงุฆู.' 
          };

        default:
          status = 'unknown_intent';
          return { 
            type: 'info', 
            text: `Developer Agent: ุฑุณุงูุฉ "${message}" ุจููุน ููุฉ ุบูุฑ ูุชููุน: "${intent.type}"` 
          };
      }

    } catch (e) {
      status = 'exception';
      Utils.error(`Developer Agent error: ${e.message}`, e.stack);
      return { 
        type: 'error', 
        text: `๐ฅ ุฎุทุฃ ูู Developer Agent: ${e.message}` 
      };
    } finally {
      const duration = Date.now() - start;
      _recordInvocation('handleRequest', status, duration, {
        sessionId,
        intentType: intent.type,
        details: { messageLength: message.length }
      });
    }
  }

  /**
   * ูููุฏ ููุฏูุง ุฃู ุตูุบุฉ ุจูุงุกู ุนูู ูุตู ุงููุณุชุฎุฏู ูุณูุงู ูุฑูุฉ ุงูุนูู.
   * @param {{ description: string }} args
   * @returns {{ type: string, text: string, data?: any }}
   */
  function generateCodeFromPrompt({ description }) {
    return Utils.executeSafely(() => {
      const sanitizedDescription = Security.sanitize(description);
      Utils.log(`AgentDeveloper: Generating code for description: "${sanitizedDescription}"`);

      // 1. ุจูุงุก ุงูุณูุงู ูู ุงููุฑูุฉ ุงููุดุทุฉ
      const sheetContext = AI.Context.build({ sessionId: 'code-gen-session', includeSheetContext: true, includeTools: false, includeLongTermMemory: false });
      const contextText = sheetContext.systemInstruction;

      // 2. ุจูุงุก Prompt ููุฏุณู ุฏููู
      const engineeredPrompt = `
ุฃูุช ุฎุจูุฑ ุจุฑูุฌุฉ Google Apps Script ูุตูุบ Google Sheets. ูููุชู ูู ุชุญููู ูุตู ุงููุณุชุฎุฏู ุฅูู ููุฏ ุฃู ุตูุบุฉ ูุงุจูุฉ ููุชูููุฐ.

**ุณูุงู ูุฑูุฉ ุงูุนูู ุงูุญุงููุฉ:**
${contextText}

**ูุตู ุงููุณุชุฎุฏู:**
"${sanitizedDescription}"

**ุงููุทููุจ:**
1.  **ุญุฏุฏ ุงูููุฉ:** ูู ุงูุทูุจ ูู (ุฃ) ุตูุบุฉ (Formula) ูุฎููุฉ ูุงุญุฏุฉุ (ุจ) ููุฏ ุจุฑูุฌู (Apps Script) ูุชูููุฐ ูููุฉ.
2.  **ูููุฏ ุงููุงุชุฌ:**
    - ุฅุฐุง ูุงูุช **ุตูุบุฉ**ุ ุฃุฑุฌุน ุงูุตูุบุฉ ููุทุ ุจุฏูู ุฃู ูุต ุฅุถุงูู. ูุซุงู: \`=VLOOKUP(A2, 'Data'!A:B, 2, FALSE)\`.
    - ุฅุฐุง ูุงู **ููุฏ ุจุฑูุฌู**ุ ุฃุฑุฌุน ุงูููุฏ ุฏุงุฎู ูุชูุฉ \`\`\`javascript. ุชุฃูุฏ ุฃู ุงูููุฏ ูุงูู ููุนูุงู.
3.  **ุฃุถู ุดุฑุญูุง:** ูู ููุฑุฉ ูููุตูุฉุ ุงุดุฑุญ ุจุฅูุฌุงุฒ ูุงุฐุง ููุนู ุงูููุฏ ุฃู ุงูุตูุบุฉ.
`;

      // 3. ุงุณุชุฏุนุงุก AI.Core
      const aiResponse = AI.Core.ask(engineeredPrompt, {
        modelOverride: Config.get('GEMINI_PRO_MODEL') || 'gemini-1.5-pro-latest',
        generationConfig: { temperature: 0.2 } // ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ููุฎูุถุฉ ููุญุตูู ุนูู ููุฏ ุฏููู
      });

      if (aiResponse.type === 'info' || aiResponse.type === 'text_response') {
        const responseText = aiResponse.text;
        const codeBlock = Utils.extractCodeBlocks(responseText, 'javascript')[0] || '';
        const explanation = Utils.removeCodeBlocks(responseText, 'javascript').trim();

        const isFormula = codeBlock.startsWith('=');

        return {
          type: 'success',
          text: 'ุชู ุชูููุฏ ุงูููุฏ ุจูุฌุงุญ.',
          data: {
            code: codeBlock,
            explanation: explanation,
            isFormula: isFormula
          }
        };
      } else {
        Utils.error('AgentDeveloper.generateCodeFromPrompt: Failed to get a valid response from AI.Core', aiResponse);
        return { type: 'error', text: `ูุดู ุชูููุฏ ุงูููุฏ: ${aiResponse.text}` };
      }

    }, [], 'AgentDeveloper.generateCodeFromPrompt');
  }

  /**
   * ูููู ุจูุฑุงุฌุนุฉ ุฃุณุจูุนูุฉ ููููุฏ ูููุฏู ุชูุงุฑูุฑ ุญูู ุฌูุฏุชู.
   * ูุณุชุฏุนู AI.Core ูุชุญููู ุงูููุฏ ููุณุฌู ุงููุชุงุฆุฌ ูู Google Sheet.
   * @returns {{ type: string, text: string }} ูุชูุฌุฉ ุงูุนูููุฉ.
   */
  function runWeeklyCodeReview() {
    return Utils.executeSafely(() => {
      Utils.log('AgentDeveloper: Starting weekly code review.');
      const projectCode = Tools.ProjectService.getProjectSourceCode();
      if (!projectCode) {
        Utils.warn('AgentDeveloper.runWeeklyCodeReview: No project source code found to review.');
        return { type: 'warning', text: 'ูุง ููุฌุฏ ููุฏ ูุดุฑูุน ูููุฑุงุฌุนุฉ.' };
      }

      const prompt = `ุฃูุช ูููุฏุณ ุจุฑูุฌูุงุช ุฎุจูุฑ ูู Google Apps Script. ุฑุงุฌุน ููุฏ G-Assistant ุงูุชุงูู ููุฏู 3 ุงูุชุฑุงุญุงุช ุฑุฆูุณูุฉ ูุชุญุณูู ุงูุฃุฏุงุกุ ุงูููุซูููุฉุ ุฃู ูุงุจููุฉ ุงูุตูุงูุฉ. ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.\n\nุงูููุฏ:\n\`\`\`javascript\n${projectCode}\n\`\`\``;
      
      // ุงูุชุฃูุฏ ูู ุฃู AI.Core ูุชุงุญ ููุงุจู ููุงุณุชุฏุนุงุก
      if (!AI || !AI.Core || typeof AI.Core.ask !== 'function') {
        Utils.error('AgentDeveloper.runWeeklyCodeReview: AI.Core.ask is not defined or callable.');
        return { type: 'error', text: 'ูุดู ูู ูุฑุงุฌุนุฉ ุงูููุฏ: ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชููุฑุฉ.' };
      }

      const reviewResult = AI.Core.ask(prompt, { modelOverride: Config.get('GEMINI_PRO_MODEL') || 'gemini-1.5-pro-latest' });

      // โ ุชุญุฏูุซ: ุชุฌููุฒ ุงููุชุงุฆุฌ ูู ูุฑุดุฉ ุงูุนูู ุจุฏูุงู ูู ุงูุณุฌู ุงูุนุงู
      const workshopSheetName = Config.get('DEVELOPER_WORKSHOP_SHEET') || 'Developer_Workshop';
      const workshopSheet = Utils.getSheet(workshopSheetName, ["ุชุงุฑูุฎ", "ุงููุฆุฉ", "ุงูููู ุงูููุชุฑุญ", "ููุฎุต ุงููุฑุงุฌุนุฉ", "ุงูููุฏ ุงูููุชุฑุญ", "ุงูุญุงูุฉ"]);

      if (workshopSheet && (reviewResult.type === 'info' || reviewResult.type === 'text_response') && reviewResult.text) {
        workshopSheet.appendRow([
            new Date(),
            'ูุฑุงุฌุนุฉ ุฃุณุจูุนูุฉ',
            'ุงููุดุฑูุน ุจุฃูููู',
            reviewResult.text,
            '', // ูุง ููุฌุฏ ููุฏ ููุชุฑุญ ูุญุฏุฏ ูู ูุฐู ุงููุฑุงุฌุนุฉ ุงูุนุงูุฉ
            'ูููุฑุงุฌุนุฉ'
        ]);
        Utils.log('AgentDeveloper: Weekly code review suggestions staged in workshop.', { sheet: workshopSheetName });
        return { type: 'success', text: 'ุชูุช ูุฑุงุฌุนุฉ ุงูููุฏ ุงูุฃุณุจูุนูุฉ ูุชุณุฌูู ุงูุงูุชุฑุงุญุงุช ุจูุฌุงุญ.' };
      } else {
        Utils.error('AgentDeveloper: Failed to get valid review result or workshop sheet.', reviewResult);
        return { type: 'error', text: 'ูุดู ูู ุงูุญุตูู ุนูู ูุชุงุฆุฌ ุงููุฑุงุฌุนุฉ ุฃู ุชุณุฌูููุง.' };
      }
    }, [], 'AgentDeveloper.runWeeklyCodeReview');
  }

  /**
   * ููุชุฑุญ ุชุญุณููุงุช ูุฅุนุงุฏุฉ ููููุฉ ููููุฏ ูู ููู ูุนูู.
   * ูุณุชุฏุนู AI.Core ูุชุญููู ุงูููุฏ ูุชูุฏูู ุงูุชุฑุงุญุงุช.
   * @param {string} fileName ุงุณู ุงูููู ุงููุฑุงุฏ ุฅุนุงุฏุฉ ููููุชู.
   * @returns {{ type: string, text: string, data?: any }} ูุชูุฌุฉ ุงูุนูููุฉ.
   */
  function suggestRefactoring(fileName) {
    return Utils.executeSafely(() => {
      const code = Tools.ProjectService.getSingleFileContent(fileName);
      if (!code) {
        Utils.warn(`AgentDeveloper.suggestRefactoring: Could not read file: ${fileName}`);
        return { type: 'warning', text: `ุชุนุฐุฑ ูุฑุงุกุฉ ูุญุชูู ุงูููู: ${fileName}.` };
      }

      const prompt = `ุฃูุช ูููุฏุณ ุจุฑูุฌูุงุช ุฎุจูุฑ. ุฑุงุฌุน ููุฏ ุงููุญุฏุฉ ุงูุชุงููุฉ (${fileName}) ูุงูุชุฑุญ ุชุญุณููุงุช ูุญุฏุฏุฉ ูุชุญุณูู ุงููุธุงูุฉ ูุงูููุงุกุฉ ูุงูุฃุฏุงุก. ุฃุฌุจ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.\n\nุงูููุฏ:\n\`\`\`javascript\n${code}\n\`\`\``;
      
      // ุงูุชุฃูุฏ ูู ุฃู AI.Core ูุชุงุญ ููุงุจู ููุงุณุชุฏุนุงุก
      if (!AI || !AI.Core || typeof AI.Core.ask !== 'function') {
        Utils.error('AgentDeveloper.suggestRefactoring: AI.Core.ask is not defined or callable.');
        return { type: 'error', text: 'ูุดู ูู ุงูุชุฑุงุญ ุฅุนุงุฏุฉ ุงูููููุฉ: ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชููุฑุฉ.' };
      }

      const refactorResult = AI.Core.ask(prompt, { modelOverride: Config.get('GEMINI_PRO_MODEL') || 'gemini-1.5-pro-latest' });

      if ((refactorResult.type === 'info' || refactorResult.type === 'text_response') && refactorResult.text) {
        Utils.log(`AgentDeveloper: Refactoring suggestions for ${fileName} generated.`, { result: refactorResult.text.substring(0, 100) });
        return { type: 'success', text: `ุชู ุงูุชุฑุงุญ ุชุญุณููุงุช ูู ${fileName}:\n${refactorResult.text}` };
      } else {
        Utils.error('AgentDeveloper: Failed to get valid refactoring suggestions.', refactorResult);
        return { type: 'error', text: `ูุดู ูู ุงูุญุตูู ุนูู ุงูุชุฑุงุญุงุช ุฅุนุงุฏุฉ ุงูููููุฉ ูู ${fileName}.` };
      }
    }, [], 'AgentDeveloper.suggestRefactoring');
  }

  /**
   * ูุณุฌู ููุงููุณ ุฌูุฏุฉ ุงูููุฏ ูููุดุฑูุน (ูุซู ุงูุชุนููุฏ ุงูุณุงูููููุงุชู ูุนุฏุฏ ุงูุฃุณุทุฑ).
   * @returns {{ type: string, text: string }} ูุชูุฌุฉ ุงูุนูููุฉ.
   */
  function logCodeQualityMetrics() {
    return Utils.executeSafely(() => {
      const files = Tools.ProjectService.getProjectFiles();
      if (!files || files.length === 0) {
        Utils.warn('AgentDeveloper.logCodeQualityMetrics: No project files found to analyze.');
        return { type: 'warning', text: 'ูุง ุชูุฌุฏ ูููุงุช ูุดุฑูุน ูุชุญููู ููุงููุณ ุงูุฌูุฏุฉ.' };
      }

      const metrics = files.map(file => {
        const complexity = _estimateCyclomaticComplexity(file.source);
        return { file: file.name, complexity: complexity, lines: file.source.split('\n').length };
      });

      const logSheetName = Config.get('CODE_QUALITY_METRICS_SHEET') || "Code_Quality_Metrics"; // ูููู ุชุนุฑูู ุงุณู ุงูุดูุช ูู Config
      const logSheet = Utils.getSheet(logSheetName, ["ุงูุชุงุฑูุฎ", "ุงูููู", "ุฏุฑุฌุฉ ุงูุชุนููุฏ", "ุนุฏุฏ ุงูุฃุณุทุฑ"]);

      if (logSheet) {
        metrics.forEach(m => logSheet.appendRow([new Date(), m.file, m.complexity, m.lines]));
        Utils.log("AgentDeveloper: Code quality metrics logged.", { count: metrics.length, sheet: logSheetName });
        return { type: 'success', text: `ุชู ุชุณุฌูู ููุงููุณ ุฌูุฏุฉ ุงูููุฏ ูู ${metrics.length} ูููุงุช ุจูุฌุงุญ.` };
      } else {
        Utils.error(`AgentDeveloper: Failed to get sheet '${logSheetName}' for logging metrics.`);
        return { type: 'error', text: `ูุดู ูู ุชุณุฌูู ููุงููุณ ุฌูุฏุฉ ุงูููุฏ: ุชุนุฐุฑ ุงููุตูู ุฅูู ุงูุดูุช.` };
      }
    }, [], 'AgentDeveloper.logCodeQualityMetrics');
  }

  /**
   * ููุฏุฑ ุงูุชุนููุฏ ุงูุณุงูููููุงุชู ูููุฏ ูุนูู.
   * @param {string} code ุงูููุฏ ุงููุฑุงุฏ ุชูุฏูุฑ ุชุนููุฏู.
   * @returns {number} ุงูุชุนููุฏ ุงูุณุงูููููุงุชู ุงูููุฏุฑ.
   * @private
   */
  function _estimateCyclomaticComplexity(code) {
    // ุชุนููุฏ ุณุงูููููุงุชู: ุนุฏุฏ ููุงุท ุงููุฑุงุฑ + 1
    // ุงููููุงุช ุงูููุชุงุญูุฉ ุงูุชู ุชุฒูุฏ ุงูุชุนููุฏ: if, for, while, case, catch, &&, ||, ?
    const keywords = (code.match(/\b(if|for|while|case|catch|&&|\|\||\?)\b/g) || []).length;
    return 1 + keywords;
  }

  // ุฅุถุงูุฉ ุฏูุงู ุฌุฏูุฏุฉ ูุญุณูุฉ
  function analyzeCodeComplexity(fileName) {
    const start = Date.now();
    let status = 'processing';

    try {
      const code = fileName ? Tools.ProjectService.getSingleFileContent(fileName) : Tools.ProjectService.getProjectSourceCode();
      if (!code) {
        status = 'no_code';
        return { 
          type: 'warning', 
          text: `ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููุฏ${fileName ? ` ููููู: ${fileName}` : ''}` 
        };
      }

      const complexity = _performDetailedComplexityAnalysis(code);
      
      // ุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
      let aiComplexityAnalysis = null;
      if (AI?.Core?.ask) {
        const complexityPrompt = `ูุฎุจูุฑ ูู ุชุญููู ุฌูุฏุฉ ุงูููุฏุ ุญูู ุงูุชุนููุฏ ุงูุชุงูู ููุฏู ุชูุตูุงุช:

ุชุญููู ุงูุชุนููุฏ:
- ุงูุชุนููุฏ ุงูุณุงูููููุงุชู: ${complexity.cyclomaticComplexity}
- ุนูู ุงูุชุฏุงุฎู: ${complexity.nestingDepth}
- ุทูู ุงูุฏูุงู: ${complexity.averageFunctionLength}
- ุนุฏุฏ ุงููุนุงููุงุช: ${complexity.averageParameters}

ุงูููุฏ:
\`\`\`javascript
${code.substring(0, 4000)}
\`\`\`

ูุฑุฌู ุชูุฏูู:
1. ุชูููู ูุณุชูู ุงูุชุนููุฏ (ููุฎูุถ/ูุชูุณุท/ุนุงูู)
2. ุงูููุงุทู ุงูุฃูุซุฑ ุชุนููุฏุงู
3. ุงูุชุฑุงุญุงุช ูุญุฏุฏุฉ ูุชูููู ุงูุชุนููุฏ
4. ุฃููููุงุช ุฅุนุงุฏุฉ ุงูููููุฉ`;

        try {
          const analysisResult = AI.Core.ask(complexityPrompt, {
            generationConfig: { temperature: 0.2, maxOutputTokens: 2000 }
          });
          
          if (analysisResult.type === 'info' && analysisResult.text) {
            aiComplexityAnalysis = analysisResult.text;
          }
        } catch (e) {
          Utils.warn('Failed to generate AI complexity analysis', e);
        }
      }

      status = 'success';
      return {
        type: 'success',
        text: aiComplexityAnalysis || 'ุชู ุชุญููู ุชุนููุฏ ุงูููุฏ ุจูุฌุงุญ',
        data: {
          fileName: fileName,
          complexity: complexity,
          aiAnalysis: aiComplexityAnalysis
        }
      };

    } catch (e) {
      status = 'exception';
      Utils.error(`Code complexity analysis failed: ${e.message}`, e.stack);
      return {
        type: 'error',
        text: `ูุดู ูู ุชุญููู ุชุนููุฏ ุงูููุฏ: ${e.message}`
      };
    } finally {
      const duration = Date.now() - start;
      _recordInvocation('analyzeCodeComplexity', status, duration, {
        details: { fileName: fileName || 'entire_project' }
      });
    }
  }

  function generateCodeDocumentation(fileName) {
    const start = Date.now();
    let status = 'processing';

    try {
      const code = fileName ? Tools.ProjectService.getSingleFileContent(fileName) : Tools.ProjectService.getProjectSourceCode();
      if (!code) {
        status = 'no_code';
        return { 
          type: 'warning', 
          text: `ุชุนุฐุฑ ูุฑุงุกุฉ ุงูููุฏ${fileName ? ` ููููู: ${fileName}` : ''}` 
        };
      }

      // ุชูููุฏ ูุซุงุฆู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
      let documentation = null;
      if (AI?.Core?.ask) {
        const docPrompt = `ูุฎุจูุฑ ูู ุชูุซูู ุงูููุฏุ ุฃูุดุฆ ูุซุงุฆู ุดุงููุฉ ููููุฏ ุงูุชุงูู:

${fileName ? `ุงูููู: ${fileName}` : 'ุงููุดุฑูุน ุงููุงูู'}

ุงูููุฏ:
\`\`\`javascript
${code}
\`\`\`

ูุฑุฌู ุฅูุดุงุก:
1. ูุตู ุนุงู ูููุญุฏุฉ/ุงููุดุฑูุน
2. ูุงุฆูุฉ ุจุงูุฏูุงู ุงูุฑุฆูุณูุฉ ูุน ูุตู ูู ุฏุงูุฉ
3. ุงููุนุงููุงุช ุงููุทููุจุฉ ูุงูุงุฎุชูุงุฑูุฉ
4. ุฃูุซูุฉ ุนูู ุงูุงุณุชุฎุฏุงู
5. ููุงุญุธุงุช ูููุฉ ูููุทูุฑูู
6. ุงูุชุจุนูุงุช ุงููุทููุจุฉ

ุชูุณูู ุงูุฅุฎุฑุงุฌ: Markdown`;

        try {
          const docResult = AI.Core.ask(docPrompt, {
            generationConfig: { temperature: 0.1, maxOutputTokens: 4000 }
          });
          
          if (docResult.type === 'info' && docResult.text) {
            documentation = docResult.text;
          }
        } catch (e) {
          Utils.error('Failed to generate documentation', e);
        }
      }

      if (!documentation) {
        status = 'ai_unavailable';
        return {
          type: 'error',
          text: 'ูุดู ูู ุชูููุฏ ุงููุซุงุฆู: ุฎุฏูุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ูุชููุฑุฉ'
        };
      }

      // ุญูุธ ุงููุซุงุฆู
      const docSheetName = Config.get('CODE_DOCUMENTATION_SHEET') || 'Code_Documentation';
      const docSheet = Utils.getSheet(docSheetName, [
        'ุงูุชุงุฑูุฎ', 'ุงูููู', 'ุงููุซุงุฆู'
      ]);

      if (docSheet) {
        docSheet.appendRow([
          new Date(),
          fileName || 'ุงููุดุฑูุน ุงููุงูู',
          documentation
        ]);
      }

      // ุญูุธ ูู ุงูุฐุงูุฑุฉ ุทูููุฉ ุงูุฃูุฏ
      if (AI?.LongTermMemory?.save) {
        AI.LongTermMemory.save('CodeDocumentation', {
          agent: 'Developer',
          fileName: fileName,
          documentation: documentation,
          timestamp: new Date().toISOString()
        });
      }

      status = 'success';
      return {
        type: 'success',
        text: 'ุชู ุชูููุฏ ูุซุงุฆู ุงูููุฏ ุจูุฌุงุญ',
        data: {
          fileName: fileName,
          documentation: documentation,
          savedToSheet: !!docSheet
        }
      };

    } catch (e) {
      status = 'exception';
      Utils.error(`Code documentation generation failed: ${e.message}`, e.stack);
      return {
        type: 'error',
        text: `ูุดู ูู ุชูููุฏ ูุซุงุฆู ุงูููุฏ: ${e.message}`
      };
    } finally {
      const duration = Date.now() - start;
      _recordInvocation('generateCodeDocumentation', status, duration, {
        details: { fileName: fileName || 'entire_project' }
      });
    }
  }

  // ุฏูุงู ูุณุงุนุฏุฉ ูุญุณูุฉ
  function _performDetailedComplexityAnalysis(code) {
    const cyclomaticComplexity = (code.match(/\b(if|for|while|case|catch|&&|\|\||\?)\b/g) || []).length + 1;
    const nestingDepth = _calculateMaxNestingDepth(code);
    const functions = code.match(/function[^{]*{[^}]*}/g) || [];
    const averageFunctionLength = functions.reduce((sum, fn) => sum + fn.split('\n').length, 0) / Math.max(functions.length, 1);
    const parameters = code.match(/function[^(]*\(([^)]*)\)/g) || [];
    const averageParameters = parameters.reduce((sum, param) => {
      const paramCount = param.split(',').filter(p => p.trim()).length;
      return sum + paramCount;
    }, 0) / Math.max(parameters.length, 1);

    return {
      cyclomaticComplexity,
      nestingDepth,
      averageFunctionLength: Math.round(averageFunctionLength),
      averageParameters: Math.round(averageParameters)
    };
  }

  function _calculateMaxNestingDepth(code) {
    let maxDepth = 0;
    let currentDepth = 0;
    
    for (let char of code) {
      if (char === '{') {
        currentDepth++;
        maxDepth = Math.max(maxDepth, currentDepth);
      } else if (char === '}') {
        currentDepth--;
      }
    }
    
    return maxDepth;
  }

  const exports = {
    handleRequest,
    generateCodeFromPrompt,
    runWeeklyCodeReview,
    suggestRefactoring,
    logCodeQualityMetrics,
    analyzeCodeComplexity,
    generateCodeDocumentation,
    MODULE_VERSION
  };

  // Register with main AI.Agents module
  if (typeof GAssistant !== 'undefined' && GAssistant.AI && GAssistant.AI.Agents) {
    GAssistant.AI.Agents.registerSubModule('Developer', exports);
  }

  return exports;
});
